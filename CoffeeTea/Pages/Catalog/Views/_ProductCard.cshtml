@using System.Globalization
@using CoffeeTea.Pages.Catalog.Models
@model CatalogItemVm

<div class="card h-100 border-0 shadow-sm rounded-4">
    <div class="position-relative">
        <a class="text-decoration-none text-dark" href="/catalog/@Model.Id">
            <img src="@(!string.IsNullOrEmpty(Model.ImageUrl) ? Model.ImageUrl : "/img/placeholder.webp")"
                 class="card-img-top rounded-top-4" alt="@Model.Name" style="object-fit:cover;height:180px;">
        </a>

        <!-- Favorite -->
        <button class="btn btn-sm position-absolute top-0 end-0 m-2 p-1 favorite-btn"
                style="background: rgba(255,255,255,0.9); border-radius: 50%; width: 32px; height: 32px;"
                aria-pressed="@(Model.IsFavorite ? "true" : "false")"
                data-id="@Model.Id"
                data-name="@Model.Name"
                data-type="@Model.Type"
                data-price="@Model.Price.ToString(CultureInfo.InvariantCulture)" 
      data-image="@(!string.IsNullOrEmpty(Model.ImageUrl) ? Model.ImageUrl : "/img/placeholder.webp")">
      <i class="fas fa-heart @(Model.IsFavorite ? "text-danger" : "text-muted")"></i>
    </button>
    </div>

    <div class="card-body d-flex flex-column">
        <div class="small text-muted mb-1">@Model.Type</div>
        <h6 class="card-title mb-2 text-truncate" title="@Model.Name">@Model.Name</h6>
        <div class="mt-auto d-flex justify-content-between align-items-center">
            <div class="fw-bold">@Model.Price.ToString("C")</div>
            <a href="/catalog/@Model.Id" class="btn btn-sm btn-primary rounded-pill">Подробнее</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.favorite-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();

          const id = btn.dataset.id;
          const name = btn.dataset.name ?? '';
          const type = btn.dataset.type ?? '';
          const price = btn.dataset.price ?? '0';
          const imageUrl = btn.dataset.image ?? '';

          const res = await fetch('/favorites/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ id, name, type, price, imageUrl })
          });

          if (!res.ok) return;
          const data = await res.json();
          if (!data?.success) return;

          const icon = btn.querySelector('i');
          if (data.isFavorite) {
            icon.classList.remove('text-muted');
            icon.classList.add('text-danger');
            btn.setAttribute('aria-pressed', 'true');
          } else {
            icon.classList.remove('text-danger');
            icon.classList.add('text-muted');
            btn.setAttribute('aria-pressed', 'false');
          }

          console.log(`Избранное (${data.count})`);
        });
      });
    });
</script>
